<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manual Campaign Entry - GTR Core</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #ffffff;
      color: #000000;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 24px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-top: 14px;
      font-weight: 600;
    }
    input, textarea, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      box-sizing: border-box;
      border: 1px solid #cfd4dc;
      border-radius: 6px;
      font-size: 14px;
    }
    textarea { resize: vertical; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .btns {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      flex-wrap: wrap;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 600;
    }
    button:hover { background: #0b5ed7; }
    .ghost { background: #6c757d; }
    .ghost:hover { background: #5a6268; }
    .danger { background: #dc3545; }
    .danger:hover { background: #c82333; }
    .muted { font-size: 0.92em; color: #555; }
    .ok { color: #17803d; font-weight: 600; }
    .err { color: #c40000; font-weight: 600; }
    .inline { display: inline-flex; align-items: center; gap: 8px; }
  </style>
</head>
<body>

<div class="container">
  <h1>Manual Campaign Entry <span class="muted">GTR Core</span></h1>

  <!-- Admin Secret -->
  <label for="secret">Admin Secret</label>
  <input id="secret" type="password" placeholder="Paste ADMIN_SECRET (stored locally if you choose)" />
  <div class="btns">
    <button type="button" class="ghost" onclick="saveSecret()">Use Secret</button>
    <label class="muted inline">
      <input id="remember" type="checkbox" />
      Remember this device
    </label>
    <button type="button" class="danger" onclick="clearSecret()">Clear Secret</button>
  </div>
  <div id="msg" class="muted">Required for API calls</div>

  <!-- Client Search + Selected -->
  <label for="clientSearch">Find Client</label>
  <input id="clientSearch" placeholder="Search name/email… (min 2 chars)" oninput="searchClients()" />

  <div class="row">
    <div>
      <label for="clientSelect">Selected Client</label>
      <select id="clientSelect">
        <option value="">Pick from list →</option>
      </select>
    </div>
    <div>
      <label for="locationId">Location ID</label>
      <input id="locationId" readonly placeholder="Auto-filled" />
    </div>
  </div>

  <div class="row">
    <div>
      <label for="runLabel">Run Label</label>
      <input id="runLabel" placeholder="e.g. 2025-08-10-newsletter" />
    </div>
    <div style="display:flex;align-items:flex-end;">
      <button type="button" onclick="suggestRunLabel()">Suggest</button>
    </div>
  </div>

  <label for="campaignName">Campaign Name</label>
  <input id="campaignName" placeholder="Aug 10 Newsletter A" />

  <label for="subject">Subject</label>
  <input id="subject" placeholder="3 Tips to Boost Leads" />

  <label for="notes">Notes</label>
  <textarea id="notes" rows="3" placeholder="Imported from GHL raw exports">Imported from GHL raw exports</textarea>

  <div class="btns" style="margin-top:20px;">
    <button type="button" onclick="saveCampaign()">Save / Upsert</button>
    <button type="button" class="ghost" onclick="clearForm()">Clear</button>
  </div>
</div>

<script>
/** Set to your deployed Worker URL */
const WORKER_BASE = 'https://gtr-cdw-campaign-admin.dennis-e64.workers.dev';

/** Storage Keys for the Admin Secret */
const SECRET_KEYS = {
  session: 'gtr_admin_secret',
  local:   'gtr_admin_secret_persist'
};

function getStoredSecret() {
  return localStorage.getItem(SECRET_KEYS.local)
      || sessionStorage.getItem(SECRET_KEYS.session)
      || '';
}
function setStoredSecret(value, persist) {
  localStorage.removeItem(SECRET_KEYS.local);
  sessionStorage.removeItem(SECRET_KEYS.session);
  if (persist) localStorage.setItem(SECRET_KEYS.local, value);
  else sessionStorage.setItem(SECRET_KEYS.session, value);
}
function saveSecret(){
  const val = document.getElementById('secret').value.trim();
  const persist = document.getElementById('remember').checked;
  const msg = document.getElementById('msg');
  if (!val) { msg.innerHTML = '<span class="err">Paste your admin secret first.</span>'; return; }
  setStoredSecret(val, persist);
  msg.innerHTML = `<span class="ok">Secret saved${persist ? ' (remembered on this device).' : ' for this session.'}</span>`;
}
function clearSecret(){
  localStorage.removeItem(SECRET_KEYS.local);
  sessionStorage.removeItem(SECRET_KEYS.session);
  document.getElementById('secret').value = '';
  document.getElementById('msg').innerHTML = '<span class="ok">Secret cleared.</span>';
}

/** Use wherever we need auth headers */
function authHeaders() {
  const s = getStoredSecret();
  return { 'X-Admin-Secret': s };
}

/** Client search */
let searchTimer = null;
async function searchClients(){
  const q = document.getElementById('clientSearch').value.trim();
  if (searchTimer) clearTimeout(searchTimer);
  searchTimer = setTimeout(async () => {
    if (q.length < 2) return;
    try {
      const res = await fetch(`${WORKER_BASE}/api/clients?q=${encodeURIComponent(q)}`, { headers: authHeaders() });
      if (!res.ok) throw new Error(await res.text());
      const clients = await res.json();
      const select = document.getElementById('clientSelect');
      select.innerHTML = '<option value="">Pick from list →</option>';
      clients.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.location_id;
        opt.textContent = c.email ? `${c.name} (${c.email})` : c.name;
        select.appendChild(opt);
      });
      select.onchange = () => {
        document.getElementById('locationId').value = select.value || '';
      };
    } catch (e) {
      alert('Error searching clients: ' + e.message);
    }
  }, 250);
}

/** Suggest a run label */
function suggestRunLabel(){
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('runLabel').value = `${today}-newsletter`;
}

/** Save campaign (upsert) */
async function saveCampaign(){
  const payload = {
    location_id: document.getElementById('locationId').value.trim(),
    run_label: document.getElementById('runLabel').value.trim(),
    campaign_name: document.getElementById('campaignName').value.trim(),
    subject: document.getElementById('subject').value.trim(),
    notes: document.getElementById('notes').value.trim()
  };
  if (!payload.location_id) return alert('Please select a client (location).');
  if (!payload.run_label) return alert('Please provide a run label.');
  try {
    const res = await fetch(`${WORKER_BASE}/api/campaigns`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...authHeaders() },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error(await res.text());
    alert('Campaign saved!');
  } catch (e) {
    alert('Error saving campaign: ' + e.message);
  }
}

/** Clear the form */
function clearForm(){
  document.getElementById('clientSearch').value = '';
  document.getElementById('clientSelect').innerHTML = '<option value="">Pick from list →</option>';
  document.getElementById('locationId').value = '';
  document.getElementById('runLabel').value = '';
  document.getElementById('campaignName').value = '';
  document.getElementById('subject').value = '';
  document.getElementById('notes').value = 'Imported from GHL raw exports';
}

/** On load, auto-apply stored secret (no need to click) */
window.addEventListener('DOMContentLoaded', () => {
  const sLocal = localStorage.getItem(SECRET_KEYS.local);
  const sSession = sessionStorage.getItem(SECRET_KEYS.session);
  const s = sLocal || sSession || '';
  const msg = document.getElementById('msg');
  if (s) {
    // Fill masked and show status
    document.getElementById('secret').value = '••••••••';
    if (sLocal) document.getElementById('remember').checked = true;
    msg.innerHTML = `<span class="ok">Admin secret loaded${sLocal ? ' (remembered on this device).' : ' for this session.'}</span>`;
  } else {
    msg.textContent = 'Required for API calls';
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campaign Manager · GTR Core</title>
  <style>
    :root { --gap: 14px; --fg:#111; --bg:#fff; --muted:#666; --blue:#1e66f5; --red:#d63939; --green:#117e24; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:900px;margin:32px auto;padding:0 18px;}
    h1{font-size:24px;margin:0 0 18px 0}
    .row{display:flex;gap:var(--gap);align-items:center;margin:10px 0}
    .col{flex:1}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input[type=text], input[type=password], textarea, select {
      width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ddd; border-radius:6px; outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px; padding:9px 14px; border-radius:6px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer}
    .btn.primary{background:var(--blue); border-color:var(--blue); color:#fff}
    .btn.danger{background:var(--red); border-color:var(--red); color:#fff}
    .muted{color:var(--muted); font-size:12px}
    .ok{color:var(--green); font-weight:600}
    .bar{display:flex;gap:var(--gap);align-items:center}
    .grow{flex:1}
    .pill{font-size:12px; padding:3px 8px; background:#eee; border-radius:999px; display:inline-block}
    .hidden{display:none;}
    hr{border:none;border-top:1px solid #ddd;margin:20px 0;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Campaign Manager 1.1 <span class="pill">GTR Core</span></h1>

  <!-- ADMIN SECRET -->
  <label>Admin Secret</label>
  <div class="bar">
    <input id="secret" type="password" placeholder="Paste ADMIN_SECRET" class="grow" />
    <button class="btn" id="useSecretBtn">Use Secret</button>
    <button class="btn danger" id="clearSecretBtn">Clear Secret</button>
  </div>
  <div class="bar" style="margin-top:6px">
    <label style="display:flex;align-items:center;gap:8px;margin:0">
      <input type="checkbox" id="rememberSecret" /> Remember this device
    </label>
    <div id="secretStatus" class="muted grow"></div>
  </div>

  <!-- CLIENT PICKER -->
  <hr>
  <label>Select Client</label>
  <select id="clientSelect">
    <option value="">Pick from list →</option>
  </select>
  <label>Location ID</label>
  <input id="locationId" type="text" readonly />

  <!-- CAMPAIGN SECTION -->
  <hr>
  <div id="campaignSection" class="hidden">
    <h2>Campaigns</h2>
    <label>Choose Existing Campaign</label>
    <select id="campaignSelect">
      <option value="">Pick from list →</option>
    </select>
    <div style="margin-top:10px;">Campaign ID: <span id="campaignIdDisplay">—</span></div>

    <h3 style="margin-top:20px;">Or Add New Campaign</h3>
    <label>Campaign Name</label>
    <input id="campaignName" type="text" placeholder="Workflow or Newsletter Name" />

    <!-- NEW: description + notes -->
    <label>Description (optional)</label>
    <textarea id="campaignDesc" placeholder="What this campaign/workflow is about"></textarea>

    <label>Notes (optional)</label>
    <textarea id="campaignNotes" placeholder="Imported from GHL raw Exports"></textarea>

    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="addCampaignBtn">Add Campaign</button>
    </div>
    <div id="campaignStatus" class="muted"></div>
  </div>

  <!-- RUNS SECTION -->
  <hr>
  <div id="runSection" class="hidden">
    <h2>Runs for Selected Campaign</h2>
    <div id="runsList" class="muted">No runs yet.</div>

    <h3 style="margin-top:20px;">Add New Run</h3>
    <label>Run Label</label>
    <input id="runLabel" type="text" placeholder="e.g. 2025-08-10-newsletter" />

    <label>Subject</label>
    <input id="subject" type="text" placeholder="Email subject line" />

    <label>Notes</label>
    <textarea id="notes" placeholder="Optional notes"></textarea>

    <div class="row" style="margin-top:16px">
      <button class="btn primary" id="saveRunBtn">Save Run</button>
    </div>
    <div style="margin-top:10px;">Run ID: <span id="runIdDisplay">—</span></div>
    <div id="runStatus" class="muted"></div>
  </div>
</div>

<script>
const WORKER_BASE = 'https://gtr-cdw-campaign-admin.dennis-e64.workers.dev';
const el = {
  secret: document.getElementById('secret'),
  rememberSecret: document.getElementById('rememberSecret'),
  useSecretBtn: document.getElementById('useSecretBtn'),
  clearSecretBtn: document.getElementById('clearSecretBtn'),
  secretStatus: document.getElementById('secretStatus'),

  clientSelect: document.getElementById('clientSelect'),
  locationId: document.getElementById('locationId'),

  campaignSection: document.getElementById('campaignSection'),
  campaignSelect: document.getElementById('campaignSelect'),
  campaignName: document.getElementById('campaignName'),
  campaignDesc: document.getElementById('campaignDesc'),
  campaignNotes: document.getElementById('campaignNotes'),
  addCampaignBtn: document.getElementById('addCampaignBtn'),
  campaignStatus: document.getElementById('campaignStatus'),
  campaignIdDisplay: document.getElementById('campaignIdDisplay'),

  runSection: document.getElementById('runSection'),
  runsList: document.getElementById('runsList'),
  runLabel: document.getElementById('runLabel'),
  subject: document.getElementById('subject'),
  notes: document.getElementById('notes'),
  saveRunBtn: document.getElementById('saveRunBtn'),
  runStatus: document.getElementById('runStatus'),
  runIdDisplay: document.getElementById('runIdDisplay')
};

function getSecret() {
  return sessionStorage.getItem('gtr_admin_secret')
      || localStorage.getItem('gtr_admin_secret')
      || '';
}
function setSecret(sec, remember) {
  sessionStorage.removeItem('gtr_admin_secret');
  localStorage.removeItem('gtr_admin_secret');
  if (remember) localStorage.setItem('gtr_admin_secret', sec);
  else sessionStorage.setItem('gtr_admin_secret', sec);
}
function showSecretStatus(msg, ok=false) {
  el.secretStatus.textContent = msg;
  el.secretStatus.className = ok ? 'ok' : 'muted';
}

async function loadClients() {
  const secret = getSecret();
  if (!secret) { showSecretStatus('Paste admin secret'); return; }
  el.clientSelect.innerHTML = '<option>Loading…</option>';
  try {
    const r = await fetch(`${WORKER_BASE}/clients`, { headers: { 'X-Admin-Secret': secret }});
    const { rows } = await r.json();
    el.clientSelect.innerHTML = '<option value="">Pick from list →</option>' +
      rows.map(row => `<option value="${row.location_id}">${row.business_name||row.full_name||row.email}</option>`).join('');
    showSecretStatus(`Loaded ${rows.length} clients`, true);
  } catch (e) {
    el.clientSelect.innerHTML = '<option value="">Pick from list →</option>';
    showSecretStatus('Failed to load clients');
  }
}

async function loadCampaigns(locationId) {
  const secret = getSecret();
  el.campaignSelect.innerHTML = '<option>Loading…</option>';
  try {
    const r = await fetch(`${WORKER_BASE}/campaigns?location_id=${encodeURIComponent(locationId)}`, { headers: { 'X-Admin-Secret': secret }});
    const { rows } = await r.json();
    el.campaignSelect.innerHTML = '<option value="">Pick from list →</option>' +
      rows.map(row => `<option value="${row.campaign_id}">${row.campaign_name}</option>`).join('');
  } catch (e) {
    el.campaignSelect.innerHTML = '<option value="">Pick from list →</option>';
  }
}

async function loadRuns(campaignId) {
  const secret = getSecret();
  try {
    const r = await fetch(`${WORKER_BASE}/runs?campaign_id=${campaignId}`, { headers: { 'X-Admin-Secret': secret }});
    const { rows } = await r.json();
    el.runsList.innerHTML = rows.length ? rows.map(rn => `${rn.run_id}: ${rn.run_label}`).join('<br>') : 'No runs yet.';
  } catch (e) {
    el.runsList.textContent = 'Error loading runs';
  }
}

// EVENT: use secret
el.useSecretBtn.onclick = () => {
  const sec = el.secret.value.trim();
  if (!sec) return alert('Paste ADMIN_SECRET');
  setSecret(sec, el.rememberSecret.checked);
  showSecretStatus('Admin secret loaded', true);
  loadClients();
};
el.clearSecretBtn.onclick = () => {
  sessionStorage.removeItem('gtr_admin_secret');
  localStorage.removeItem('gtr_admin_secret');
  el.secret.value = '';
  showSecretStatus('Secret cleared');
};

// EVENT: client chosen
el.clientSelect.onchange = () => {
  el.locationId.value = el.clientSelect.value || '';
  if (el.clientSelect.value) {
    el.campaignSection.classList.remove('hidden');
    loadCampaigns(el.clientSelect.value);
  } else {
    el.campaignSection.classList.add('hidden');
    el.runSection.classList.add('hidden');
  }
};

// EVENT: campaign chosen
el.campaignSelect.onchange = () => {
  const cid = el.campaignSelect.value;
  if (cid) {
    el.campaignIdDisplay.textContent = cid;
    el.runSection.classList.remove('hidden');
    loadRuns(cid);
  } else {
    el.campaignIdDisplay.textContent = '—';
    el.runSection.classList.add('hidden');
  }
};

// EVENT: add campaign (now sends description + notes, appends, clears fields)
el.addCampaignBtn.onclick = async () => {
  const secret = getSecret();
  const location_id   = el.locationId.value;
  const campaign_name = el.campaignName.value.trim();
  const description   = (el.campaignDesc.value || '').trim();
  const notes         = (el.campaignNotes.value || '').trim();
  if (!campaign_name) return alert('Campaign name required');

  try {
    const r = await fetch(`${WORKER_BASE}/campaigns`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Admin-Secret': secret },
      body: JSON.stringify({ location_id, campaign_name, description, notes })
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(t || 'Add campaign failed');
    }
    const { campaign_id } = await r.json();

    // Add to dropdown immediately (do NOT change selection)
    const opt = new Option(campaign_name, String(campaign_id));
    el.campaignSelect.add(opt);

    // Clear fields for rapid next entry
    el.campaignName.value = '';
    el.campaignDesc.value = '';
    el.campaignNotes.value = '';

    // Feedback (include new id)
    el.campaignStatus.textContent = `Campaign added ✔ (ID ${campaign_id})`;

    // Optional: refresh list to keep ordering fresh
    loadCampaigns(location_id);
  } catch (e) {
    el.campaignStatus.textContent = 'Error adding campaign';
    alert(e.message || e);
  }
};

// EVENT: save run
el.saveRunBtn.onclick = async () => {
  const secret = getSecret();
  const campaign_id = el.campaignSelect.value;
  const run_label = el.runLabel.value.trim();
  const subject = el.subject.value.trim();
  const notes = el.notes.value.trim();
  if (!campaign_id) return alert('Pick a campaign first');
  if (!run_label)   return alert('Run label required');
  try {
    const r = await fetch(`${WORKER_BASE}/runs`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Admin-Secret': secret },
      body: JSON.stringify({ campaign_id, run_label, subject, notes })
    });
    if (!r.ok) {
      const t = await r.text();
      throw new Error(t || 'Save run failed');
    }
    const { run_id } = await r.json();
    el.runStatus.textContent = 'Run saved ✔';
    el.runIdDisplay.textContent = run_id;
    loadRuns(campaign_id);
  } catch (e) {
    el.runStatus.textContent = 'Error saving run';
    alert(e.message || e);
  }
};

// Init
(function init(){
  const sec = getSecret();
  if (sec) {
    el.secret.value = sec;
    if (localStorage.getItem('gtr_admin_secret')) el.rememberSecret.checked = true;
    loadClients();
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manual Campaign Entry 1.0 · GTR Core</title>
  <style>
    :root { --gap: 14px; --fg:#111; --bg:#fff; --muted:#666; --blue:#1e66f5; --red:#d63939; --green:#117e24; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    .wrap{max-width:900px;margin:32px auto;padding:0 18px;}
    h1{font-size:24px;margin:0 0 18px 0}
    .row{display:flex;gap:var(--gap);align-items:center;margin:10px 0}
    .col{flex:1}
    label{display:block;font-weight:600;margin:12px 0 6px}
    input[type=text], input[type=password], textarea, select {
      width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ddd; border-radius:6px; outline:none;
    }
    textarea{min-height:110px; resize:vertical}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px; padding:9px 14px; border-radius:6px; border:1px solid #ddd; background:#f6f6f6; cursor:pointer}
    .btn.primary{background:var(--blue); border-color:var(--blue); color:#fff}
    .btn.danger{background:var(--red); border-color:var(--red); color:#fff}
    .muted{color:var(--muted); font-size:12px}
    .ok{color:var(--green); font-weight:600}
    .bar{display:flex;gap:var(--gap);align-items:center}
    .grow{flex:1}
    .pill{font-size:12px; padding:3px 8px; background:#eee; border-radius:999px; display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Manual Campaign Entry 1.0 <span class="pill">GTR Core</span></h1>

    <!-- ADMIN SECRET -->
    <label>Admin Secret</label>
    <div class="bar">
      <input id="secret" type="password" placeholder="Paste ADMIN_SECRET (stored on this device if you check remember)" class="grow" />
      <button class="btn" id="useSecretBtn">Use Secret</button>
      <button class="btn danger" id="clearSecretBtn">Clear Secret</button>
    </div>
    <div class="bar" style="margin-top:6px">
      <label style="display:flex;align-items:center;gap:8px;margin:0">
        <input type="checkbox" id="rememberSecret" /> Remember this device
      </label>
      <div id="secretStatus" class="muted grow"></div>
    </div>

    <!-- CLIENT PICKER -->
    <div class="row" style="margin-top:18px">
      <div class="col">
        <label>Selected Client</label>
        <select id="clientSelect">
          <option value="">Pick from list →</option>
        </select>
      </div>
      <div class="col">
        <label>Location ID</label>
        <input id="locationId" type="text" placeholder="Auto-filled" readonly />
      </div>
    </div>

    <!-- CAMPAIGN INFO -->
    <label>Campaign Name</label>
    <input id="campaignName" type="text" placeholder="Aug 10 Newsletter A" />

    <!-- RUN LABEL -->
    <div class="row">
      <div class="col">
        <label>Run Label</label>
        <input id="runLabel" type="text" placeholder="e.g. 2025-08-10-newsletter" />
      </div>
      <div style="align-self:flex-end">
        <button class="btn primary" id="suggestBtn">Suggest</button>
      </div>
    </div>

    <label>Subject</label>
    <input id="subject" type="text" placeholder="3 Tips to Boost Leads" />

    <label>Notes</label>
    <textarea id="notes" placeholder="Imported from GHL raw exports"></textarea>

    <div class="row" style="margin-top:16px">
      <button class="btn primary" id="saveBtn">Save / Upsert</button>
      <button class="btn" id="clearBtn">Clear</button>
      <div id="saveStatus" class="muted"></div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const WORKER_BASE = 'https://gtr-cdw-campaign-admin.dennis-e64.workers.dev';

  // === DOM ===
  const el = {
    secret: document.getElementById('secret'),
    rememberSecret: document.getElementById('rememberSecret'),
    useSecretBtn: document.getElementById('useSecretBtn'),
    clearSecretBtn: document.getElementById('clearSecretBtn'),
    secretStatus: document.getElementById('secretStatus'),

    clientSelect: document.getElementById('clientSelect'),
    locationId: document.getElementById('locationId'),

    runLabel: document.getElementById('runLabel'),
    suggestBtn: document.getElementById('suggestBtn'),

    campaignName: document.getElementById('campaignName'),
    subject: document.getElementById('subject'),
    notes: document.getElementById('notes'),

    saveBtn: document.getElementById('saveBtn'),
    clearBtn: document.getElementById('clearBtn'),
    saveStatus: document.getElementById('saveStatus'),
  };

  // === SECRET PERSISTENCE ===
  function getSecret() {
    return sessionStorage.getItem('gtr_admin_secret')
        || localStorage.getItem('gtr_admin_secret')
        || '';
  }
  function setSecret(sec, remember) {
    sessionStorage.removeItem('gtr_admin_secret');
    localStorage.removeItem('gtr_admin_secret');
    if (remember) localStorage.setItem('gtr_admin_secret', sec);
    else sessionStorage.setItem('gtr_admin_secret', sec);
  }
  function showSecretStatus(msg, ok=false) {
    el.secretStatus.textContent = msg;
    el.secretStatus.className = ok ? 'ok' : 'muted';
  }

  // === LOAD CLIENTS (all) ===
  async function loadClients() {
    const secret = getSecret();
    if (!secret) { showSecretStatus('Paste admin secret to load clients'); return; }

    el.clientSelect.innerHTML = '<option value="">Loading…</option>';
    try {
      const r = await fetch(`${WORKER_BASE}/clients`, {
        headers: { 'X-Admin-Secret': secret }
      });
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`clients fetch failed: ${t}`);
      }
      const { rows } = await r.json();

      // Build options
      const opts = ['<option value="">Pick from list →</option>'];
      rows.forEach(row => {
        const label =
          row.business_name?.trim() ||
          row.full_name?.trim() ||
          row.email?.trim() ||
          row.location_id;
        const extra = row.email ? ` — ${row.email}` : '';
        opts.push(`<option value="${encodeHTML(row.location_id)}" data-name="${encodeHTML(label)}">${encodeHTML(label)}${encodeHTML(extra)}</option>`);
      });
      el.clientSelect.innerHTML = opts.join('');
      showSecretStatus(`Loaded ${rows.length} clients`, true);
    } catch (e) {
      el.clientSelect.innerHTML = '<option value="">Pick from list →</option>';
      alert(e.message || e);
      showSecretStatus('Failed to load clients');
    }
  }

  // === HELPERS ===
  function encodeHTML(s){ return (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }

  // === EVENTS ===
  el.useSecretBtn.onclick = () => {
    const sec = el.secret.value.trim();
    const remember = el.rememberSecret.checked;
    if (!sec) { alert('Paste ADMIN_SECRET'); return; }
    setSecret(sec, remember);
    showSecretStatus('Admin secret loaded' + (remember ? ' (remembered on this device).' : '.'), true);
    loadClients();
  };
  el.clearSecretBtn.onclick = () => {
    sessionStorage.removeItem('gtr_admin_secret');
    localStorage.removeItem('gtr_admin_secret');
    el.secret.value = '';
    showSecretStatus('Secret cleared');
    el.clientSelect.innerHTML = '<option value="">Pick from list →</option>';
    el.locationId.value = '';
  };

  // When a client is chosen → fill location_id
  el.clientSelect.onchange = () => {
    const loc = el.clientSelect.value || '';
    el.locationId.value = loc;
  };

  // Suggest run label
  el.suggestBtn.onclick = () => {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const base = el.campaignName.value.trim() || el.subject.value.trim() || 'newsletter';
    el.runLabel.value = `${yyyy}-${mm}-${dd}-${slug(base)}`;
  };

  // Clear form
  el.clearBtn.onclick = () => {
    el.clientSelect.value = '';
    el.locationId.value = '';
    el.runLabel.value = '';
    el.campaignName.value = '';
    el.subject.value = '';
    el.notes.value = '';
    el.saveStatus.textContent = '';
  };

  // Save / Upsert
  el.saveBtn.onclick = async () => {
    const secret = getSecret();
    if (!secret) { alert('Admin secret required'); return; }

    const location_id = el.locationId.value.trim();
    const run_label = el.runLabel.value.trim();
    const campaign_name = el.campaignName.value.trim();
    const subject = el.subject.value.trim();
    const notes = el.notes.value.trim();

    if (!location_id) return alert('Pick a client first');
    if (!run_label) return alert('Run label is required');

    el.saveStatus.textContent = 'Saving…';
    try {
      const r = await fetch(`${WORKER_BASE}/campaigns`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Secret': secret
        },
        body: JSON.stringify({ location_id, run_label, campaign_name, subject, notes })
      });
      const t = await r.text();
      if (!r.ok) throw new Error(t || 'Save failed');
      el.saveStatus.textContent = 'Saved ✔';
      setTimeout(()=> el.saveStatus.textContent='', 2500);
    } catch (e) {
      el.saveStatus.textContent = 'Save failed';
      alert(e.message || e);
    }
  };

  function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
function todayISO(){ const d=new Date(); return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }

// Auto-fill when leaving Campaign Name
document.getElementById('campaignName').addEventListener('blur', () => {
  const run = document.getElementById('runLabel');
  if (run.value.trim()) return; // don’t overwrite if user already set it
  const base = document.getElementById('campaignName').value.trim() || document.getElementById('subject').value.trim() || 'campaign';
  run.value = `${todayISO()}-${slug(base)}`;
});

// Keep the manual Suggest button too
document.getElementById('suggestBtn').onclick = () => {
  const base = document.getElementById('campaignName').value.trim() || document.getElementById('subject').value.trim() || 'campaign';
  document.getElementById('runLabel').value = `${todayISO()}-${slug(base)}`;
};

  // Auto-load secret + clients on first visit if remembered
  (function init(){
    const sec = getSecret();
    if (sec) {
      el.secret.value = sec;
      showSecretStatus('Admin secret loaded' + (localStorage.getItem('gtr_admin_secret') ? ' (remembered).' : '.'), true);
      if (localStorage.getItem('gtr_admin_secret')) el.rememberSecret.checked = true;
      loadClients();
    }
  })();
</script>
</body>
</html>
